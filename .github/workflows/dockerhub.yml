# ============================================
# GitHub Actions - Push to Docker Hub
# ============================================
# Triggers after the main build workflow completes successfully.
# Pulls the image from GHCR and pushes to Docker Hub for discoverability.
# Also syncs the README as the Docker Hub overview.

name: Push to Docker Hub

on:
  workflow_run:
    workflows: ["Build and Push CSS Server"]
    types: [completed]
  workflow_dispatch:  # Allow manual triggers

jobs:
  push-to-dockerhub:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    permissions:
      contents: read
      packages: read

    steps:
      - name: Free up disk space
        run: |
          echo "=== Before cleanup ==="
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/julia*
          sudo rm -rf /usr/share/kotlinc
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /opt/microsoft
          sudo rm -rf /opt/pipx
          sudo docker image prune --all --force
          echo "=== After cleanup ==="
          df -h

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read version
        id: version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION | tr -d '[:space:]')
            MAJOR_MINOR="${VERSION%.*}"
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "major_minor=${MAJOR_MINOR}" >> $GITHUB_OUTPUT
            echo "Version from VERSION file: ${VERSION}"
          else
            echo "version=" >> $GITHUB_OUTPUT
            echo "major_minor=" >> $GITHUB_OUTPUT
            echo "No VERSION file found"
          fi

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull from GHCR and push to Docker Hub
        run: |
          GHCR_IMAGE="ghcr.io/${GITHUB_REPOSITORY,,}:latest"
          DH_USER="${{ secrets.DOCKERHUB_USERNAME }}"
          VERSION="${{ steps.version.outputs.version }}"
          MAJOR_MINOR="${{ steps.version.outputs.major_minor }}"

          echo "Pulling ${GHCR_IMAGE}..."
          docker pull "${GHCR_IMAGE}"

          # Always push latest
          docker tag "${GHCR_IMAGE}" "${DH_USER}/css-server:latest"
          docker push "${DH_USER}/css-server:latest"
          echo "Pushed: latest"

          # Push version tags if VERSION file exists
          if [ -n "${VERSION}" ]; then
            docker tag "${GHCR_IMAGE}" "${DH_USER}/css-server:${VERSION}"
            docker tag "${GHCR_IMAGE}" "${DH_USER}/css-server:${MAJOR_MINOR}"
            docker push "${DH_USER}/css-server:${VERSION}"
            docker push "${DH_USER}/css-server:${MAJOR_MINOR}"
            echo "Pushed: ${VERSION}, ${MAJOR_MINOR}"
          fi

          echo "Done!"

      - name: Update Docker Hub description
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ secrets.DOCKERHUB_USERNAME }}/css-server
          readme-filepath: ./README.md
          short-description: "Counter-Strike: Source dedicated server with MetaMod, SourceMod, and SM-RIPExt"
