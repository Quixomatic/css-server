# ============================================
# GitHub Actions - Push to Docker Hub
# ============================================
# Triggers after the main build workflow completes successfully.
# Pulls the image from GHCR and pushes to Docker Hub for discoverability.

name: Push to Docker Hub

on:
  workflow_run:
    workflows: ["Build and Push CSS Server"]
    types: [completed]
    branches: [main, master]
  workflow_dispatch:  # Allow manual triggers

jobs:
  push-to-dockerhub:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull from GHCR and push to Docker Hub
        run: |
          GHCR_IMAGE="ghcr.io/${GITHUB_REPOSITORY,,}:latest"
          DOCKERHUB_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/css-server:latest"
          SHA_TAG="${{ secrets.DOCKERHUB_USERNAME }}/css-server:${{ github.event.workflow_run.head_sha }}"

          echo "Pulling ${GHCR_IMAGE}..."
          docker pull "${GHCR_IMAGE}"

          echo "Tagging for Docker Hub..."
          docker tag "${GHCR_IMAGE}" "${DOCKERHUB_IMAGE}"
          docker tag "${GHCR_IMAGE}" "${SHA_TAG}"

          echo "Pushing to Docker Hub..."
          docker push "${DOCKERHUB_IMAGE}"
          docker push "${SHA_TAG}"

          echo "Done! Pushed ${DOCKERHUB_IMAGE} and ${SHA_TAG}"
