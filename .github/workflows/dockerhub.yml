# ============================================
# GitHub Actions - Push to Docker Hub
# ============================================
# Triggers after the main build workflow completes successfully.
# Pulls the image from GHCR and pushes to Docker Hub for discoverability.

name: Push to Docker Hub

on:
  workflow_run:
    workflows: ["Build and Push CSS Server"]
    types: [completed]
    branches: [main, master]
  workflow_dispatch:  # Allow manual triggers

jobs:
  push-to-dockerhub:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Free up disk space
        run: |
          echo "=== Before cleanup ==="
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/julia*
          sudo rm -rf /usr/share/kotlinc
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /opt/microsoft
          sudo rm -rf /opt/pipx
          sudo docker image prune --all --force
          echo "=== After cleanup ==="
          df -h

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull from GHCR and push to Docker Hub
        run: |
          GHCR_IMAGE="ghcr.io/${GITHUB_REPOSITORY,,}:latest"
          DH_USER="${{ secrets.DOCKERHUB_USERNAME }}"

          echo "Pulling ${GHCR_IMAGE}..."
          docker pull "${GHCR_IMAGE}"

          # Always push latest
          docker tag "${GHCR_IMAGE}" "${DH_USER}/css-server:latest"
          docker push "${DH_USER}/css-server:latest"

          # Push version tag if available (extract from GHCR tags)
          # The build workflow tags semver versions, so check for them
          TAGS=$(docker inspect "${GHCR_IMAGE}" --format '{{ "{{" }}json .RepoTags{{ "}}" }}' 2>/dev/null || echo "[]")
          echo "Available tags: ${TAGS}"

          # Also try to get version from the workflow run's head branch (tag name)
          VERSION_TAG="${{ github.event.workflow_run.head_branch }}"
          if [[ "${VERSION_TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            VERSION="${VERSION_TAG#v}"
            MAJOR_MINOR="${VERSION%.*}"

            echo "Version detected: ${VERSION}"
            docker tag "${GHCR_IMAGE}" "${DH_USER}/css-server:${VERSION}"
            docker tag "${GHCR_IMAGE}" "${DH_USER}/css-server:${MAJOR_MINOR}"
            docker push "${DH_USER}/css-server:${VERSION}"
            docker push "${DH_USER}/css-server:${MAJOR_MINOR}"
            echo "Pushed version tags: ${VERSION}, ${MAJOR_MINOR}"
          else
            echo "No version tag detected (branch: ${VERSION_TAG}), pushing latest only"
          fi

          echo "Done!"
